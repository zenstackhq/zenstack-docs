---
description: Adapter for integrating with Fastify
sidebar_position: 2
---

import ErrorHandling from './_error-handling.md';
import ApiRequest from './_api-request.md';
import CommonOptions from './_common-options.md';

# Fastify

The `@zenstackhq/server/fastify` module provides a quick way to install OpenAPI endpoints onto a [Fastify](https://www.fastify.io/) project for exposing database CRUD. Combined with ZenStack's power of enhancing Prisma with access policies, it's surprisingly simple to achieve a secure data backend without manually coding it.

```ts
/**
 * Fastify plugin options
 */
export interface PluginOptions {
    /**
     * Url prefix, e.g.: /api
     */
    prefix: string;

    /**
     * Callback for getting a PrismaClient for the given request
     */
    getPrisma: (request: FastifyRequest, reply: FastifyReply) => unknown | Promise<unknown>;

    /**
     * Logger settings
     */
    logger?: LoggerConfig;

    /**
     * Zod schemas for validating request input. Pass `true` to load from standard location (need to enable `@core/zod` plugin in schema.zmodel).
     */
    zodSchemas?: ModelZodSchema | boolean;
}

const pluginHandler: FastifyPluginCallback<PluginOptions> = (fastify, options, done) => { ... }
```

### Mounting the APIs

You can integrate ZenStack into your project with the `ZenStackFastifyPlugin` [fastify plugin](https://www.fastify.io/docs/latest/Reference/Plugins/):

```ts
import { withPresets } from '@zenstackhq/runtime';
import { ZenStackFastifyPlugin } from '@zenstackhq/server/fastify';
import { prisma } from './db.ts';
import { getSessionUser } from './auth.ts';

const server = fastify();

// serve OpenAPI at /api/openapi
server.register(ZenStackFastifyPlugin, {
    prefix: '/api/openapi',
    // getSessionUser extracts the current session user from the request, its
    // implementation depends on your auth solution
    getPrisma: (request) => withPresets(prisma, { user: getSessionUser(request) }),
});
```

The Fastify adapter takes the following options to initialize:

-   prefix: `string`

    The API path to install the OpenAPI CRUD endpoints.

-   getPrisma: `(request: FastifyRequest, reply: FastifyReply) => unknown | Promise<unknown>`

    A callback for getting a PrismaClient instance for talking to the database. Usually you'll use an enhanced instance created with ZenStack's [`withPresets`](/docs/reference/runtime-api#withpresets) or [`withPolicy`](/docs/reference/runtime-api#withpolicy) APIs to ensure access policies are enforced.

-   zodSchemas: `ModelZodSchema | boolean | undefined`

    Provides the Zod schemas used for validating CRUD request input. The Zod schemas can be generated with the `@core/zod` plugin. Pass `true` for this option to load the schemas from the default location. If you configured `@core/zod` plugin to output to a custom location, you can load the schemas explicitly and pass the loaded module to this option.

    Not passing this option or passing in `undefined` disables input validation.

### Using the APIs

The APIs mounted by `ZenStackFastifyPlugin` conforms to the OpenAPI V3 spec, and provides a path for each model and database operation combination, as listed [here](/docs/reference/plugins/openapi#generated-api-paths).

<ApiRequest />

<ErrorHandling />
